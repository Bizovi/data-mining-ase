---
title: "Schools and Sample Sizes"
output: html_document
---

Scoli din US, N. 
Fiecare scoala are un numar de studenti ($x_i$). Mari si mici (n(mari), n(mici))
n_studenti(mari), n_studenti(mici)
Scoruri SAT (distributie aleasa) - top K% cele mai performante scoli sunt mici??
BREAK UP BIG SCHOOLS? Is it good idea?

- Corelatie != Causalitatee
- Max != Average
- Tendinta naturala, Concentrare? -> e.g. lot olimpic: *Ipoteza!*
- Sampling bias? Selection bias ...
- Specializari? (N/A - vorbim despre liceeni)
- Varianta!! Top dar si la coada

```{r import-packages}
library(tidyverse)
```

- N = numarul scolilor
- ((n_scoli / 2), n_stud_mici) => medie la nivel de scoala
- ((n_scoli / 2), n_stud_mari) => medie la nivel de scoala
- dimensiune | perf_medie

```{r parameters-study}
N <- 3000  # small schools are half of the total
n_stud_small <- 100
n_stud_big <- 1000

# Hypothetical distribution of the statistical population
# scores ~ N(mean, sd)
population_score_mean <- 500
population_score_sd <- 100
```

```{r simulate-student-scores}
# generate a matrix with N/2 rows and n_stud_small columns
small_schools <- matrix(
  rnorm(N/2 * n_stud_small, mean=population_score_mean, sd=population_score_sd),
  nrow = N/2,
  ncol = n_stud_small,
)

big_schools <- matrix(
  rnorm(N/2 * n_stud_big, mean=population_score_mean, sd=population_score_sd),
  nrow = N/2,
  ncol = n_stud_big,
)
```

```{r compute-school-mean}
# mean per school for big schools
mean_big <- rowMeans(big_schools)

# mean per school for small schools
mean_small <- rowMeans(small_schools)

# put together in a data.frame
# size    | average_score
# "big"   | scores big
# "small" | scores small
# compute a new column - to standardize scores

df_small <- data.frame(size="small", average_score=mean_small)
df_big <- data.frame(size="big", average_score=mean_big)
df <- rbind(df_small, df_big) %>%
  dplyr::mutate(standard_score = (average_score - mean(average_score)) / sd(average_score)) %>%
  dplyr::arrange(dplyr::desc(standard_score))

# print top 100 scoli
df[1:10, ]
```

```{r plot-scores}
df %>% 
  ggplot(aes(x = standard_score, color = size)) + 
  geom_density() + 
  theme_minimal()
```


```{r define-simulations}
simulare_scoruri_scoli <- function(n_scoli = 3000, n_stud_mici = 50, n_stud_mari = 1000) {
  scoli_mici <- matrix(
    rnorm(n_scoli/2 * n_stud_mici, mean=500, sd=25),
    ncol = n_stud_mici,
    nrow = n_scoli/2
  )
  
  scoli_mari <- matrix(
    rnorm(n_scoli/2 * n_stud_mari, mean=500, sd=25),
    ncol = n_stud_mari,
    nrow = n_scoli/2
  )
  
  c(dim(scoli_mici), dim(scoli_mari))
  df_mici <- data.frame(
    dimensiune = "mici", 
    performanta = rowMeans(scoli_mici)
  )
  
  df_mari <- data.frame(
    dimensiune = "mari",
    performanta = rowMeans(scoli_mari)
  )
  
  df <- rbind(df_mari, df_mici)
  p <- df %>% dplyr::arrange(dplyr::desc(performanta)) %>% 
    mutate(idx = row_number()) %>% 
    mutate(perf_norm = (performanta - mean(performanta)) / sd(performanta)) %>% 
    ggplot(aes(x = idx, y = perf_norm, fill = dimensiune)) + 
    geom_col() + 
    theme_minimal()
  list(df, p)
}

results <- simulare_scoruri_scoli()
```

```{r}
# Distributie a scorurilor in cadrul unei scoli 
# Simulare
# Grafic
results[[1]] %>%
  arrange(desc(performanta)) %>% 
  filter(performanta >= 500) %>% 
  group_by(dimensiune) %>% 
  summarise(n = n())

results[[2]]
```



$$
\frac{\sigma}{\sqrt{n}}
$$
